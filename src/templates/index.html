{% extends "base.html" %}
{% load static %}

{% block title %}Tra cứu hoá đơn 24/7{% endblock %}

{% block content %}
  <div
    class="min-h-screen"
    x-data="image_data()"
    x-cloak
  >
    <div class="flex min-h-screen max-md:flex-col gradient-bg">
      <main class="flex flex-1 items-center justify-center w-full">
        <div class="relative bg-white w-full max-w-[420px] rounded-2xl p-8 pb-12 shadow-[0_20px_40px_rgba(0,0,0,0.08)] max-sm:px-5">
          <div class="text-3xl font-semibold">
            Tra cứu hoá đơn 24/7
          </div>
          <div class="text-sm text-slate-500 mt-2">
            Nhập mã hoá đơn để xem hình ảnh chi tiết
          </div>
          <div x-data="search_data()" class="space-y-4 mt-7">
            {% include "components/form/input.html" with id="codeInput" model_key="code" error_text_key="code_error_text" on_enter_key="on_search" label="Mã hoá đơn" placeholder="Ví dụ: HD2026XXXX" required=True helper_text="Mã hoá đơn không phân biệt chữ hoa và chữ thường" error_id="errorText" autocomplete="off" %}
            {% include "components/form/text_button.html" with has_spinner=True loading_key="loading" text="Tra cứu" on_click="on_search" %}
            <script>
              function search_data() {
                return {
                  code: '',
                  code_error_text: '',
                  loading: false,
                  init() {
                    this.$nextTick(() => {
                      document.getElementById('codeInput')?.focus();
                    });
                    this.$watch('code', value => {
                      const url = new URL(window.location);
                      if (value.trim()) {
                        this.code_error_text = '';
                        url.searchParams.set('code', value.trim().toUpperCase());
                      } else {
                        this.code_error_text = 'Vui lòng nhập mã hoá đơn.';
                        url.searchParams.delete('code');
                      }
                      window.history.replaceState({}, '', url);
                    });
                    {% if receipt %}
                      this.$nextTick(() => {
                        this.code = '{{ receipt.code }}';
                        this.src_image = '{{ receipt.image.url|escapejs }}';
                        this.show_thumbnail = true;
                      });
                    {% endif %}
                  },
                  on_search(event) {
                    if (this.loading) return;
                    if (!this.code.trim()) {
                      this.code_error_text = 'Vui lòng nhập mã hoá đơn.';
                      return;
                    }
                    this.loading = true;
                    this.code_error_text = '';
                    this.show_thumbnail = false;
                    $.ajax({
                      url: '{% url "receipt-search" code="_code_" %}'.replace('_code_', this.code.trim()),
                      method: 'GET',
                      dataType: 'json'
                    })
                    .done((data) => {
                      setTimeout(() => {
                        this.src_image = data.image_url;
                        this.show_thumbnail = true;
                        this.loading = false;
                      }, 500);
                    })
                    .fail((xhr) => {
                      if (xhr.status === 404) {
                        this.code_error_text = 'Không tìm thấy hoá đơn với mã đã nhập.';
                      } else {
                        this.code_error_text = 'Đã có lỗi xảy ra. Vui lòng thử lại sau.';
                      }
                      this.loading = false;
                    });
                  },
                }
              }
            </script>
          </div>
          <div
            class="mt-7 w-full"
            x-show="show_thumbnail"
            x-collapse
            >
            <div class="flex flex-col items-center">
              <div
                class="w-[260px] h-[360px] mx-auto rounded-xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center overflow-hidden cursor-pointer"
                x-on:click="show_modal = true"
              >
                <img
                  :src="src_image"
                  alt="Ảnh hoá đơn"
                  class="w-full h-full object-contain rounded-xl border border-gray-300"
                >
              </div>
              <div class="mt-3 text-xs text-slate-500">
                Nhấn vào ảnh để xem với kích thước lớn hơn
              </div>
            </div>
          </div>
          <div class="absolute bottom-2 left-0 w-full text-center text-xs text-slate-400">
            &copy; {% now "Y" %} Tra cứu hóa đơn 24/7.
          </div>
        </div>
      </main>
    </div>
    {% include "components/image_modal.html" with src_key="src_image" show_modal_key="show_modal" %}
    <script>
      function image_data() {
        return {
          src_image: '',
          show_thumbnail: false,
          show_modal: false,
        }
      }
    </script>
  </div>
{% endblock %}
